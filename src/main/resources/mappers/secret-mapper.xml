<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="secretMapper">

	<resultMap type="Board" id="board_rm">
		<id property="boardNo" column="BOARD_NO"/>

		<result property="boardTitle" column="BOARD_TITLE"/>
		<result property="boardContent" column="BOARD_CONTENT"/>
		<result property="createDate" column="BOARD_CREATE_DT"/>
		<result property="modifyDate" column="BOARD_MODIFY_DT"/>
		<result property="replyCheckCode" column="REPLY_CHECK_CD"/>
		<result property="scrapCheckCode" column="SCRAP_CHECK_CD"/>
		<result property="anonCheckCode" column="ANON_CHECK_CD"/>
		<result property="empathyCheckCode" column="EM_CHECK_CD"/>
		<result property="readCount" column="BOARD_READ_COUNT"/>
		<result property="memberNo" column="MEMBER_NO"/>
		<result property="memberFn" column="MEMBER_FN"/>
		<result property="memberId" column="MEMBER_ID"/>
		<result property="professionNo" column="PROFESSION_NO"/>
		<result property="professionName" column="PROFESSION_NM"/>
		<result property="statusCode" column="BOARD_STATUS_CD"/>
		<result property="boardCategoryCode" column="BOARD_CATEGORY_CD"/>
		<result property="boardCategoryName" column="BOARD_CATEGORY_NM"/>
		<result property="worryCategoryCode" column="WORRY_CATEGORY_CD"/>
		<result property="worryCategoryName" column="WORRY_CATEGORY_NM"/>
		
		<result property="replyCount" column="REPLY_COUNT"/>
		<result property="memberImage" column="MEMBER_IMAGE"/>
		<result property="empathyStatusCode" column="EMPATHY_STATUS_CD"/>
		<result property="professionImage" column="PROFESSION_IMAGE"/>
		
		<result property="likeCount" column="L_COUNT"/>
		<result property="cheerCount" column="C_COUNT"/>
		<result property="sadCount" column="SA_COUNT"/>
		<result property="angryCount" column="A_COUNT"/>
		<result property="surpriseCount" column="SU_COUNT"/>
		<result property="profrssionImage" column="PROFESSION_IMAGE"/>

		<result property="worryEmpathyArray" column="EMPATHY_ARRAY"/>
		<result property="worryCntArray" column="CNT_ARRAY"/>

		<result property="imageName" column="IMAGE_NM"/>
		<result property="imagePath" column="IMAGE_PATH"/>
		<result property="postNo" column="POST_NO"/>
		<result property="maxValue" column="MAX_VALUE"/>
		
		<result property="empathyStatusName" column="EMPATHY_STATUS_NM"/>
		<result property="reviewStarpoint" column="REVIEW_STARPOINT"/>
		<result property="proIntro" column="PRO_INTRO"/>
		<result property="counselPrice" column="COUNSEL_PRICE"/>
		<result property="avgReviewStarpoint" column="AVG_REVIEW_STARPOINT"/>
		<result property="countStar" column="COUNT_STAR"/>
	
		<collection property="imgList" column="BOARD_NO"
					javaType="java.util.ArrayList" ofType="Image" select="selectBoardImageList"/> 
		
		<!--<collection property="profileImgList" column="BOARD_NO"
					javaType="java.util.ArrayList" ofType="Image" select="selectFropileImageList"/>
		<collection property="emList" column="BOARD_NO"
					javaType="java.util.ArrayList" ofType="Empathy" select="selectEmpathyList"/>-->
	</resultMap>
	
	
		<resultMap type="Image" id="image_rm">
		<id property="imageNo" column="IMAGE_NO"/>
		<result property="imagePath" column="IMAGE_PATH"/>
		<result property="imageName" column="IMAGE_NM"/>
		<result property="imageOriginal" column="IMAGE_ORIGINAL"/>
		<result property="imageLevel" column="IMAGE_LEVEL"/>
		<result property="memberNo" column="MEMBER_NO"/>
		<result property="boardNo" column="PROFESSION_NO"/>
		<result property="professionNo" column="BOARD_NO"/>
	</resultMap>
	
    <resultMap type="Empathy" id="empathy_rm">
    	<result property="memberNo" column="MEMBER_NO"/>
    	<result property="boardNo" column="BOARD_NO"/>
    	<result property="empathyStatusCode" column="EMPATHY_STATUS_CD"/>

    </resultMap>
    
    <resultMap id="scrap_rm" type="Scrap">
		<id property="scrapNo" column="SCRAP_NO"/>
		<result property="memberNo" column="MEMBER_NO"/>
		<result property="boardNo" column="BOARD_NO"/>
		<result property="boardTitle" column="BOARD_TITLE"/>
		<result property="boardContent" column="BOARD_CONTENT"/>
		<result property="imagePath" column="IMAGE_PATH"/>
		<result property="imageName" column="IMAGE_NM"/>
		<result property="boardStatusCode" column="BOARD_STATUS_CD"/>
		<result property="readCount" column="BOARD_READ_COUNT"/>
		<result property="enrollDate" column="ENROLL_DT"/>
		<result property="maxValue" column="MAX_VALUE"/>
 	</resultMap>
 	


	<!-- 털어놓기 게시글 -->
	<select id="selectSecretList" resultMap="board_rm">
		SELECT MEMBER.MEMBER_NO, MEMBER_ID, MEMBER_FN,
			BOARD.BOARD_NO, BOARD_CONTENT, BOARD_CREATE_DT,
			REPLY_CHECK_CD,SCRAP_CHECK_CD,EM_CHECK_CD,ANON_CHECK_CD,
			e.EMPATHY_ARRAY, e.CNT_ARRAY,
			(SELECT COUNT(*) FROM REPLY WHERE BOARD_NO = BOARD.BOARD_NO) REPLY_COUNT
		FROM BOARD
		LEFT JOIN MEMBER ON MEMBER.MEMBER_NO = BOARD.MEMBER_NO
		LEFT JOIN(
			SELECT
				a.BOARD_NO,
				LISTAGG(  a.EMPATHY_STATUS_CD, ',' ) WITHIN GROUP (ORDER BY a.EMPATHY_STATUS_CD) AS EMPATHY_ARRAY,
				LISTAGG(  a.cnt, ',' ) WITHIN GROUP (ORDER BY a.cnt) AS CNT_ARRAY
			FROM (
				SELECT BOARD_NO, EMPATHY_STATUS_CD, COUNT(EMPATHY_STATUS_CD) cnt
				FROM EMPATHY
				GROUP BY BOARD_NO, EMPATHY_STATUS_CD
			) a
			GROUP BY BOARD_NO
		) e on e.BOARD_NO = BOARD.BOARD_NO
		WHERE BOARD_CATEGORY_CD = 104

		<if test="searchCategory != null">
			<bind name="val" value="'%' + searchText + '%'"/>

			<choose>
				<when test="searchCategory == 'id'">
					AND MEMBER_FN LIKE #{val}
				</when>
				<otherwise>
					AND BOARD_CONTENT LIKE #{val}
				</otherwise>
			</choose>
		</if>
		ORDER BY BOARD.BOARD_NO DESC
	</select>
	
	<!-- 털어놓기게시판 게시글 작성 -->
	<insert id="insertSecretBoard"  useGeneratedKeys="true" parameterType="Board">
		
	    <selectKey order="BEFORE" resultType="_int" keyProperty="boardNo">
	         SELECT SEQ_BOARD_NO.NEXTVAL FROM DUAL
	    </selectKey>
	    
		INSERT INTO BOARD 
		VALUES(#{boardNo},DEFAULT, #{boardContent}, DEFAULT, DEFAULT, DEFAULT, 
				#{replyCheckCode},#{scrapCheckCode},#{boardCategoryCode},#{memberNo},
				DEFAULT,DEFAULT,#{empathyCheckCode},#{anonCheckCode},DEFAULT)
	</insert>
	
	<!-- 게시판 이미지 삽입 -->
	<insert id="insertImgList" >
		
   		INSERT INTO IMAGE VALUES (SEQ_IMAGE_NO.NEXTVAL, #{imagePath},
					 #{imageName},
					 #{imageOriginal},
					 #{imageLevel},
					 DEFAULT,DEFAULT,
					 #{boardNo})
   </insert>
	
	
	
	
	<!-- 게시글 수정 -->
	<update id="updateBoard">
		UPDATE BOARD SET 
		BOARD_CONTENT = #{boardContent},
		MODIFY_DT = SYSDATE
		WHERE BOARD_NO = #{boardNo}
	</update>
	
	
	<!-- 게시글 상세 조회 -->
	<select id="selectBoard" resultMap="board_rm">
	SELECT BOARD_NO, BOARD_CONTENT,
		    MEMBER_NO, MEMBER_FN,
		    TO_CHAR(BOARD_CREATE_DT, 'YYYY"년" MM"월" DD"일" HH24"시" MI"분" SS"초"' ) BOARD_CREATE_DT,
		    TO_CHAR(BOARD_MODIFY_DT, 'YYYY"년" MM"월" DD"일" HH24"시" MI"분" SS"초"' ) BOARD_MODIFY_DT,
		    BOARD_READ_COUNT, REPLY_CHECK_CD, SCRAP_CHECK_CD, EM_CHECK_CD, ANON_CHECK_CD
		FROM BOARD 
		JOIN MEMBER USING(MEMBER_NO)
		WHERE BOARD_NO = #{boardNo}
		AND BOARD_STATUS_CD = 201
	</select>
	
	<!-- 게시판 이미지 조회-->
   <select id="selectBoardImageList" resultMap="image_rm">
      <if test="#{boardNo} != null ">
         SELECT * FROM IMAGE
         WHERE BOARD_NO = #{boardNo}
         ORDER BY IMAGE_LEVEL
      </if>
   </select>
	
	<!-- 게시글 조회 수 증가 -->
	<update id="increaseReadCount" >
		UPDATE BOARD SET 
		BOARD_READ_COUNT = BOARD_READ_COUNT + 1 
		WHERE BOARD_NO = #{boardNo}
	</update>
	
	<!-- 게시글 삭제  -->
	<update id="deleteBoard">
		UPDATE BOARD SET 
		BOARD_STATUS_CD = 203,
		BOARD_MODIFY_DT = SYSDATE
		WHERE BOARD_NO = #{boardNo} 
	</update>
	
	
	
	
	

</mapper>
